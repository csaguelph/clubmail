// Prisma schema for Better Auth
// learn more: https://better-auth.com/docs/concepts/database

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

// NOTE: When using mysql or sqlserver, uncomment the //@db.Text annotations in model Account below
// Further reading:
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// User & Auth Models
// ========================================

enum UserRole {
  ADMIN
  USER
}

model User {
  id            String    @id
  name          String //@db.Text
  email         String
  emailVerified Boolean   @default(false)
  role          UserRole  @default(USER)
  lastLoginAt   DateTime? // Track when user last logged in (null = stub user)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  // Club relationships
  clubsCreated   Club[]
  clubMemberships ClubMember[]
  campaignsCreated Campaign[]
  mediaUploads   Media[]

  @@unique([email])
  @@map("user")
}

// ========================================
// Club Models
// ========================================

model Club {
  id                 String   @id @default(cuid())
  name               String
  slug               String   @unique
  gryphlifeId        String?
  organizationEmail  String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  members      ClubMember[]
  settings     ClubSettings?
  emailLists   EmailList[]
  subscribers  Subscriber[]
  campaigns    Campaign[]
  media        Media[]

  @@index([slug])
  @@index([createdById])
  @@index([gryphlifeId])
}

enum ClubRole {
  CLUB_OWNER
  CLUB_EDITOR
  CLUB_VIEWER
}

model ClubMember {
  id        String   @id @default(cuid())
  role      ClubRole
  createdAt DateTime @default(now())

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([clubId, userId])
  @@index([userId])
}

model ClubSettings {
  id                    String  @id @default(cuid())
  fromName              String
  fromEmailSlug         String  @default("")
  replyToEmail          String?
  defaultSubjectPrefix  String?
  brandColor            String  @default("#b1d135")
  enableTracking        Boolean @default(true)
  socialLinks           Json?   @default("{}") // JSON object: { "facebook": "url", "twitter": "url", ... }

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String @unique
}

// ========================================
// Email List & Subscriber Models
// ========================================

model EmailList {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String

  memberships SubscriberListMembership[]
  campaigns   Campaign[]

  @@index([clubId])
}

enum SubscriberStatus {
  SUBSCRIBED
  UNSUBSCRIBED
  BOUNCED
  BLOCKED // Hard bounces or too many soft bounces
}

model Subscriber {
  id                String           @id @default(cuid())
  email             String
  name              String?
  status            SubscriberStatus @default(SUBSCRIBED)
  unsubscribeToken  String           @unique @default(cuid())
  customFields      Json?            @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String

  listMemberships SubscriberListMembership[]
  emails          Email[]
  bounces         BounceEvent[]
  complaints      ComplaintEvent[]

  @@unique([clubId, email])
  @@index([clubId])
  @@index([email])
}

model SubscriberListMembership {
  subscribedAt   DateTime? @default(now())
  unsubscribedAt DateTime?

  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  subscriberId String
  emailList    EmailList  @relation(fields: [emailListId], references: [id], onDelete: Cascade)
  emailListId  String

  @@id([subscriberId, emailListId])
  @@index([emailListId])
}

// ========================================
// Campaign Models
// ========================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

model Campaign {
  id            String         @id @default(cuid())
  name          String
  subject       String
  preheaderText String?
  fromName      String
  fromEmail     String
  designJson    String         @db.Text
  html          String         @db.Text
  status        CampaignStatus @default(DRAFT)
  scheduledFor  DateTime?      // When the campaign should be sent (for scheduled campaigns)
  scheduledAt   DateTime?      // When the campaign was scheduled (timestamp of scheduling action)
  qstashMessageId String?      // QStash message ID for scheduled campaigns (for cancellation)
  startedAt     DateTime?
  finishedAt    DateTime?
  archivedAt    DateTime?
  tags          String[]       @default([])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  club   Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String

  emailList   EmailList @relation(fields: [emailListId], references: [id])
  emailListId String

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  emails Email[]

  @@index([clubId])
  @@index([status])
  @@index([scheduledFor])
  @@index([archivedAt])
}

// ========================================
// Email Tracking Models
// ========================================

model Email {
  id                 String       @id @default(cuid())
  trackingToken      String       @unique @default(cuid())
  providerMessageId  String?
  status             EmailStatus  @default(QUEUED)
  errorMessage       String?
  sentAt             DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId String

  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  subscriberId String

  opens      EmailOpen[]
  clicks     EmailClick[]
  bounces    BounceEvent[]
  complaints ComplaintEvent[]

  @@index([campaignId])
  @@index([subscriberId])
  @@index([status])
  @@index([trackingToken])
}

enum EmailStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  COMPLAINED
  FAILED
}

model EmailOpen {
  id        String   @id @default(cuid())
  userAgent String?
  ipAddress String?
  openedAt  DateTime @default(now())

  email   Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)
  emailId String

  @@index([emailId])
  @@index([openedAt])
}

model EmailClick {
  id        String   @id @default(cuid())
  url       String
  userAgent String?
  ipAddress String?
  clickedAt DateTime @default(now())

  email   Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)
  emailId String

  @@index([emailId])
  @@index([clickedAt])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String? //@db.Text
  userAgent String? //@db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String //@db.Text
  providerId            String //@db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String? //@db.Text
  refreshToken          String? //@db.Text
  idToken               String? //@db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String? //@db.Text
  password              String? //@db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String //@db.Text
  value      String //@db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// ========================================
// Media Upload Models
// ========================================

model Media {
  id          String   @id @default(cuid())
  filename    String // Original filename
  key         String   @unique // Storage key in R2
  url         String // Public URL
  mimeType    String
  size        Int // File size in bytes
  width       Int? // For images
  height      Int? // For images
  altText     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  club   Club?   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubId String?

  uploadedBy   User   @relation(fields: [uploadedById], references: [id])
  uploadedById String

  @@index([clubId])
  @@index([uploadedById])
  @@index([mimeType])
  @@index([createdAt])
}

// ========================================
// Platform Settings (Global Admin Configuration)
// ========================================

model PlatformSettings {
  id                        String   @id @default("platform_settings")
  // Bounce thresholds
  softBounceThreshold       Int      @default(2) // Number of soft bounces before unsubscribing
  hardBounceAction          String   @default("BLOCK") // BLOCK or UNSUBSCRIBE
  // Complaint thresholds
  complaintThreshold        Int      @default(1) // Number of complaints before unsubscribing
  complaintAction           String   @default("UNSUBSCRIBE") // BLOCK or UNSUBSCRIBE
  // Auto-cleanup settings
  enableAutoCleanup         Boolean  @default(true)
  // Rate limiting settings (AWS SES throttle limits)
  maxEmailsPerDay           Int      @default(50000) // Maximum emails per 24-hour period
  maxEmailsPerSecond        Int      @default(14) // Maximum emails per second (SES default sending rate)
  enableRateLimiting        Boolean  @default(true) // Enable rate limiting checks
  // Metadata
  updatedAt                 DateTime @updatedAt
  createdAt                 DateTime @default(now())
}

// ========================================
// Bounce & Complaint Tracking
// ========================================

enum BounceType {
  SOFT // Temporary failure (mailbox full, server down)
  HARD // Permanent failure (invalid email, domain doesn't exist)
}

model BounceEvent {
  id                   String     @id @default(cuid())
  bounceType           BounceType
  bounceSubType        String? // e.g., "General", "MailboxFull", "MessageTooLarge"
  diagnosticCode       String?    @db.Text
  providerMessageId    String? // SES Message ID
  feedbackId           String? // SES Feedback ID
  reportingMTA         String? // Mail Transfer Agent that reported the bounce
  action               String? // e.g., "failed"
  status               String? // SMTP status code
  createdAt            DateTime   @default(now())

  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id], onDelete: SetNull)
  subscriberId String?

  email   Email?  @relation(fields: [emailId], references: [id], onDelete: SetNull)
  emailId String?

  @@index([subscriberId])
  @@index([emailId])
  @@index([createdAt])
}

model ComplaintEvent {
  id                   String   @id @default(cuid())
  complaintFeedbackType String? // e.g., "abuse", "fraud", "virus"
  userAgent            String?
  providerMessageId    String? // SES Message ID
  feedbackId           String? // SES Feedback ID
  arrivalDate          DateTime?
  createdAt            DateTime @default(now())

  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id], onDelete: SetNull)
  subscriberId String?

  email   Email?  @relation(fields: [emailId], references: [id], onDelete: SetNull)
  emailId String?

  @@index([subscriberId])
  @@index([emailId])
  @@index([createdAt])
}

// ========================================
// SNS Webhook Log (for debugging and audit)
// ========================================

model SNSWebhookLog {
  id            String   @id @default(cuid())
  messageType   String // e.g., "Bounce", "Complaint", "Delivery"
  messageId     String
  payload       String   @db.Text
  processed     Boolean  @default(false)
  error         String?  @db.Text
  createdAt     DateTime @default(now())

  @@index([messageType])
  @@index([processed])
  @@index([createdAt])
}
